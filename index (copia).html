<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Art 583 CCyC ‚Äì Defensor√≠a Civil y Comercial 6 (con Firestore)</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            text-align: center;
        }
        .header h1, .header h2 { color: #2c3e50; font-weight: 700; }
        .header h2 { font-size: 2.2rem; margin-bottom: 10px; }
        .article-info {
            background: #f8f9fa;
            border-left: 4px solid #007bff;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            font-size: 0.95rem;
            line-height: 1.6;
        }
        .article-info h3 { color: #007bff; margin-bottom: 10px; }
        .controls {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        .controls-row { display: flex; gap: 15px; align-items: center; flex-wrap: wrap; margin-bottom: 15px; }
        .btn {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white; border: none; padding: 12px 24px; border-radius: 8px;
            cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.3s ease;
            text-decoration: none; display: inline-flex; align-items: center; gap: 8px;
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(0,123,255,.3); }
        .btn-success { background: linear-gradient(135deg, #28a745, #1e7e34); }
        .btn-danger { background: linear-gradient(135deg, #dc3545, #c82333); }
        .btn-warning { background: linear-gradient(135deg, #ffc107, #e0a800); color: #212529; }
        .btn-small { padding: 6px 12px; font-size: 12px; }
        .search-box { flex: 1; min-width: 300px; padding: 12px 16px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 14px; transition: border-color .3s ease; }
        .search-box:focus { outline: none; border-color: #007bff; box-shadow: 0 0 0 3px rgba(0,123,255,.1); }
        .cases-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .case-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px; padding: 25px; box-shadow: 0 8px 32px rgba(0,0,0,.1);
            transition: all .3s ease; cursor: pointer;
        }
        .case-card:hover { transform: translateY(-5px); box-shadow: 0 12px 40px rgba(0,0,0,.15); }
        .case-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px; }
        .case-number { font-size: 1.2rem; font-weight: 700; color: #007bff; }
        .case-status { padding: 4px 12px; border-radius: 20px; font-size: .8rem; font-weight: 600; text-transform: uppercase; }
        .status-pendiente { background: #fff3cd; color: #856404; }
        .status-en-proceso { background: #d1ecf1; color: #0c5460; }
        .status-resuelto { background: #d4edda; color: #155724; }
        .case-info { margin-bottom: 15px; }
        .case-info p { margin-bottom: 8px; font-size: .9rem; }
        .case-info strong { color: #495057; }
        .case-actions { display: flex; gap: 8px; margin-top: 15px; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,.5); backdrop-filter: blur(5px); }
        .modal-content { background: white; margin: 2% auto; padding: 0; border-radius: 15px; width: 90%; max-width: 800px; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,.3); animation: modalSlideIn .3s ease; }
        @keyframes modalSlideIn { from { opacity: 0; transform: translateY(-50px); } to { opacity: 1; transform: translateY(0); } }
        .modal-header { background: linear-gradient(135deg, #007bff, #0056b3); color: white; padding: 20px 30px; border-radius: 15px 15px 0 0; display: flex; justify-content: space-between; align-items: center; gap: 10px; }
        .modal-header h2 { margin: 0; font-size: 1.5rem; }
        .modal-actions { display: flex; align-items: center; gap: 8px; }
        .close { color: white; font-size: 28px; font-weight: bold; cursor: pointer; transition: opacity .3s ease; }
        .close:hover { opacity: .7; }
        .modal-body { padding: 30px; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #495057; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 12px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 14px; transition: border-color .3s ease; }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: #007bff; box-shadow: 0 0 0 3px rgba(0,123,255,.1); }
        .form-group textarea { resize: vertical; min-height: 100px; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .detail-section { margin-bottom: 25px; padding: 20px; background: #f8f9fa; border-radius: 10px; }
        .detail-section h3 { color: #007bff; margin-bottom: 15px; font-size: 1.2rem; border-bottom: 2px solid #007bff; padding-bottom: 5px; }
        .detail-item { display: grid; grid-template-columns: 1fr 2fr; gap: 10px; margin-bottom: 10px; padding: 8px 0; border-bottom: 1px solid #e9ecef; }
        .detail-item:last-child { border-bottom: none; }
        .detail-label { font-weight: 600; color: #495057; }
        .detail-value { color: #6c757d; }
        .no-cases { text-align: center; padding: 60px 20px; color: #6c757d; font-size: 1.1rem; }
        .no-cases i { font-size: 4rem; margin-bottom: 20px; opacity: .5; }
        @media (max-width: 768px) {
            .container { padding: 10px; }
            .header h2 { font-size: 1.8rem; }
            .controls-row { flex-direction: column; align-items: stretch; }
            .search-box { min-width: auto; }
            .cases-grid { grid-template-columns: 1fr; }
            .form-row { grid-template-columns: 1fr; }
            .modal-content { width: 95%; margin: 5% auto; }
            .detail-item { grid-template-columns: 1fr; gap: 5px; }
        }
        @media print {
            body { background: white; }
            .container { max-width: none; padding: 0; }
            .controls, .case-actions, .modal-header .close { display: none !important; }
            .case-card, .modal-content { box-shadow: none; border: 1px solid #ddd; break-inside: avoid; margin-bottom: 20px; }
            .modal { display: block !important; position: static; background: none; }
            .modal-content { margin: 0; width: 100%; max-height: none; overflow: visible; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h2>Registro Art 583 CCyC ‚Äì Defensor√≠a Civil y Comercial 6</h2>
            <div class="article-info">
                <h3>ART√çCULO 583. Reclamaci√≥n en supuestos de filiaci√≥n con sola maternidad</h3>
                <p>El Registro Civil debe comunicar al Ministerio P√∫blico cuando un ni√±o/a figure s√≥lo con filiaci√≥n materna, procurando la determinaci√≥n de paternidad y reconocimiento. Debe instarse a la madre a suministrar el nombre del presunto padre y datos para su individualizaci√≥n, bajo juramento previo aviso de consecuencias legales.</p>
                <p>Antes de remitir la comunicaci√≥n, el Registro cita e informa a la madre sobre derechos y deberes. Cumplido ello, se remiten actuaciones al Ministerio P√∫blico para promover acci√≥n judicial.</p>
            </div>
        </div>

        <div class="controls">
            <div class="controls-row">
                <button class="btn btn-success" onclick="openModal('add')">‚ûï Nuevo Caso</button>
                <input type="text" class="search-box" id="searchInput" placeholder="Buscar casos por cualquier campo..." onkeyup="filterCases()" />
                <button class="btn btn-warning" onclick="printAllCases()">üñ®Ô∏è Imprimir Todo</button>
            </div>
        </div>

        <div id="casesContainer" class="cases-grid"></div>
        <div id="noCases" class="no-cases" style="display:none;">
            <div>üìÅ</div>
            <p>No hay casos registrados</p>
            <p>Haga clic en "Nuevo Caso" para comenzar</p>
        </div>
    </div>

    <!-- Modal para agregar/editar casos -->
    <div id="caseModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Nuevo Caso</h2>
                <div class="modal-actions">
                    <!-- Bot√≥n imprimir dentro del modal de casos (pedido 3) -->
                    <button class="btn btn-warning btn-small" onclick="printCaseFromForm()">üñ®Ô∏è Imprimir</button>
                    <span class="close" onclick="closeModal()">&times;</span>
                </div>
            </div>
            <div class="modal-body">
                <form id="caseForm">
                    <div class="detail-section">
                        <h3>Informaci√≥n General del Caso</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="numeroExpediente">N√∫mero de Expediente *</label>
                                <input type="text" id="numeroExpediente" required />
                            </div>
                            <div class="form-group">
                                <label for="fechaIngreso">Fecha de Ingreso *</label>
                                <input type="date" id="fechaIngreso" required />
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="estado">Estado del Caso *</label>
                                <select id="estado" required>
                                    <option value="">Seleccionar estado</option>
                                    <option value="pendiente">Pendiente</option>
                                    <option value="en-proceso">En Proceso</option>
                                    <option value="resuelto">Resuelto</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="prioridad">Prioridad</label>
                                <select id="prioridad">
                                    <option value="normal">Normal</option>
                                    <option value="alta">Alta</option>
                                    <option value="urgente">Urgente</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="detail-section">
                        <h3>Informaci√≥n del Menor</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="nombreMenor">Nombre del Menor *</label>
                                <input type="text" id="nombreMenor" required />
                            </div>
                            <div class="form-group">
                                <label for="apellidoMenor">Apellido del Menor *</label>
                                <input type="text" id="apellidoMenor" required />
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="fechaNacimiento">Fecha de Nacimiento</label>
                                <input type="date" id="fechaNacimiento" />
                            </div>
                            <div class="form-group">
                                <label for="dniMenor">DNI del Menor</label>
                                <input type="text" id="dniMenor" />
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="lugarNacimiento">Lugar de Nacimiento</label>
                            <input type="text" id="lugarNacimiento" />
                        </div>
                    </div>

                    <div class="detail-section">
                        <h3>Informaci√≥n de la Madre</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="nombreMadre">Nombre de la Madre *</label>
                                <input type="text" id="nombreMadre" required />
                            </div>
                            <div class="form-group">
                                <label for="apellidoMadre">Apellido de la Madre *</label>
                                <input type="text" id="apellidoMadre" required />
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="dniMadre">DNI de la Madre</label>
                                <input type="text" id="dniMadre" />
                            </div>
                            <div class="form-group">
                                <label for="telefonoMadre">Tel√©fono de la Madre</label>
                                <input type="text" id="telefonoMadre" />
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="domicilioMadre">Domicilio de la Madre</label>
                            <input type="text" id="domicilioMadre" />
                        </div>
                    </div>

                    <div class="detail-section">
                        <h3>Informaci√≥n del Presunto Padre</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="nombrePadre">Nombre del Presunto Padre</label>
                                <input type="text" id="nombrePadre" />
                            </div>
                            <div class="form-group">
                                <label for="apellidoPadre">Apellido del Presunto Padre</label>
                                <input type="text" id="apellidoPadre" />
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="dniPadre">DNI del Presunto Padre</label>
                                <input type="text" id="dniPadre" />
                            </div>
                            <div class="form-group">
                                <label for="telefonoPadre">Tel√©fono del Presunto Padre</label>
                                <input type="text" id="telefonoPadre" />
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="domicilioPadre">Domicilio del Presunto Padre</label>
                            <input type="text" id="domicilioPadre" />
                        </div>
                        <div class="form-group">
                            <label for="informacionAdicionalPadre">Informaci√≥n Adicional para Individualizaci√≥n</label>
                            <textarea id="informacionAdicionalPadre" placeholder="Informaci√≥n √∫til para individualizaci√≥n y paradero"></textarea>
                        </div>
                    </div>

                    <div class="detail-section">
                        <h3>Actuaciones Procesales</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="fechaCitacionMadre">Fecha de Citaci√≥n a la Madre</label>
                                <input type="date" id="fechaCitacionMadre" />
                            </div>
                            <div class="form-group">
                                <label for="fechaDeclaracionJuramento">Fecha de Declaraci√≥n bajo Juramento</label>
                                <input type="date" id="fechaDeclaracionJuramento" />
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="fechaRemisionMP">Fecha de Remisi√≥n al Ministerio P√∫blico</label>
                                <input type="date" id="fechaRemisionMP" />
                            </div>
                            <div class="form-group">
                                <label for="numeroOficioMP">N√∫mero de Oficio al Ministerio P√∫blico</label>
                                <input type="text" id="numeroOficioMP" />
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="observacionesActuaciones">Observaciones de las Actuaciones</label>
                            <textarea id="observacionesActuaciones" placeholder="Detalles sobre actuaciones"></textarea>
                        </div>
                    </div>

                    <div class="detail-section">
                        <h3>Seguimiento Judicial</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="juzgadoInterviniente">Juzgado Interviniente</label>
                                <input type="text" id="juzgadoInterviniente" />
                            </div>
                            <div class="form-group">
                                <label for="numeroExpedienteJudicial">N√∫mero de Expediente Judicial</label>
                                <input type="text" id="numeroExpedienteJudicial" />
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="fechaInicioAccion">Fecha de Inicio de Acci√≥n Judicial</label>
                                <input type="date" id="fechaInicioAccion" />
                            </div>
                            <div class="form-group">
                                <label for="estadoJudicial">Estado Judicial</label>
                                <select id="estadoJudicial">
                                    <option value="">Sin acci√≥n judicial</option>
                                    <option value="iniciado">Acci√≥n Iniciada</option>
                                    <option value="en-tramite">En Tr√°mite</option>
                                    <option value="sentencia">Con Sentencia</option>
                                    <option value="apelacion">En Apelaci√≥n</option>
                                    <option value="firme">Sentencia Firme</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="observacionesJudiciales">Observaciones Judiciales</label>
                            <textarea id="observacionesJudiciales" placeholder="Detalles del proceso judicial"></textarea>
                        </div>
                    </div>

                    <div class="detail-section">
                        <h3>Notas y Observaciones Generales</h3>
                        <div class="form-group">
                            <label for="notasGenerales">Notas Generales</label>
                            <textarea id="notasGenerales" placeholder="Informaci√≥n adicional relevante"></textarea>
                        </div>
                    </div>

                    <div style="text-align:center; margin-top: 30px;">
                        <button type="submit" class="btn btn-success">üíæ Guardar Caso</button>
                        <button type="button" class="btn" onclick="closeModal()" style="margin-left:10px;">‚ùå Cancelar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal para ver detalles -->
    <div id="detailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="detailModalTitle">Detalles del Caso</h2>
                <div class="modal-actions">
                    <button class="btn btn-warning btn-small" onclick="printCase()" style="margin-right:10px;">üñ®Ô∏è Imprimir</button>
                    <span class="close" onclick="closeDetailModal()">&times;</span>
                </div>
            </div>
            <div class="modal-body" id="detailModalBody"></div>
        </div>
    </div>

    <!-- Firebase + Firestore (m√≥dulos) -->
    <script type="module">
        // 1) Inicializar Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
        import {
            getFirestore, collection, doc, setDoc, addDoc, getDoc, getDocs, onSnapshot,
            deleteDoc, serverTimestamp, enableIndexedDbPersistence, query, orderBy
        } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDaMuUaVI_61xHMQoRSsIkHi9fqvZgkj6s",
            authDomain: "articulo583.firebaseapp.com",
            projectId: "articulo583",
            storageBucket: "articulo583.firebasestorage.app",
            messagingSenderId: "972837111055",
            appId: "1:972837111055:web:aa37d0d28d8b0d0a0f6a7a"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        enableIndexedDbPersistence(db).catch(() => {/* puede fallar en inc√≥gnito/m√∫ltiples pesta√±as */});

        // Estado local (se mantiene la arquitectura/UX original)
        let cases = JSON.parse(localStorage.getItem('defensoriaCases')) || [];
        let currentEditingId = null;

        const casesRef = collection(db, 'casos');

        // Suscripci√≥n en tiempo real a Firestore (pedido 2)
        const q = query(casesRef);
        onSnapshot(q, (snapshot) => {
            const remote = [];
            snapshot.forEach(docSnap => {
                const data = docSnap.data();
                // Asegurar existencia de id
                if (!data.id) data.id = docSnap.id;
                remote.push(data);
            });
            cases = remote;
            localStorage.setItem('defensoriaCases', JSON.stringify(cases)); // espejo local (fallback)
            renderCases();
        });

        // Migraci√≥n inicial: subir locales que no existan a√∫n
        (async function migrateLocalToRemote(){
            try {
                const existing = new Set();
                const snap = await getDocs(casesRef);
                snap.forEach(d=> existing.add(d.id));
                for (const c of cases) {
                    const id = c.id || String(Date.now());
                    if (!existing.has(id)) {
                        c.id = id;
                        await setDoc(doc(db, 'casos', id), {
                            ...c,
                            fechaCreacion: c.fechaCreacion || (new Date().toISOString().split('T')[0])
                        }, { merge: true });
                    }
                }
            } catch (e) { /* silencioso */ }
        })();

        // Cargar UI al iniciar
        document.addEventListener('DOMContentLoaded', function() {
            renderCases();
        });

        // UI logic (id√©ntica a la original, con persistencia remota a√±adida)
        window.openModal = function(mode, caseId = null) {
            const modal = document.getElementById('caseModal');
            const modalTitle = document.getElementById('modalTitle');
            const form = document.getElementById('caseForm');
            if (mode === 'add') { modalTitle.textContent = 'Nuevo Caso'; form.reset(); currentEditingId = null; }
            else if (mode === 'edit') { modalTitle.textContent = 'Editar Caso'; currentEditingId = caseId; loadCaseData(caseId); }
            modal.style.display = 'block';
        }
        window.closeModal = function() { document.getElementById('caseModal').style.display = 'none'; currentEditingId = null; }
        window.closeDetailModal = function() { document.getElementById('detailModal').style.display = 'none'; }

        function loadCaseData(caseId) {
            const caseData = cases.find(c => c.id === caseId);
            if (!caseData) return;
            Object.keys(caseData).forEach(key => {
                const element = document.getElementById(key);
                if (element) element.value = caseData[key] || '';
            });
        }

        async function saveCaseData() {
            const caseData = {
                id: currentEditingId || Date.now().toString(),
                numeroExpediente: document.getElementById('numeroExpediente').value,
                fechaIngreso: document.getElementById('fechaIngreso').value,
                estado: document.getElementById('estado').value,
                prioridad: document.getElementById('prioridad').value,
                nombreMenor: document.getElementById('nombreMenor').value,
                apellidoMenor: document.getElementById('apellidoMenor').value,
                fechaNacimiento: document.getElementById('fechaNacimiento').value,
                dniMenor: document.getElementById('dniMenor').value,
                lugarNacimiento: document.getElementById('lugarNacimiento').value,
                nombreMadre: document.getElementById('nombreMadre').value,
                apellidoMadre: document.getElementById('apellidoMadre').value,
                dniMadre: document.getElementById('dniMadre').value,
                telefonoMadre: document.getElementById('telefonoMadre').value,
                domicilioMadre: document.getElementById('domicilioMadre').value,
                nombrePadre: document.getElementById('nombrePadre').value,
                apellidoPadre: document.getElementById('apellidoPadre').value,
                dniPadre: document.getElementById('dniPadre').value,
                telefonoPadre: document.getElementById('telefonoPadre').value,
                domicilioPadre: document.getElementById('domicilioPadre').value,
                informacionAdicionalPadre: document.getElementById('informacionAdicionalPadre').value,
                fechaCitacionMadre: document.getElementById('fechaCitacionMadre').value,
                fechaDeclaracionJuramento: document.getElementById('fechaDeclaracionJuramento').value,
                fechaRemisionMP: document.getElementById('fechaRemisionMP').value,
                numeroOficioMP: document.getElementById('numeroOficioMP').value,
                observacionesActuaciones: document.getElementById('observacionesActuaciones').value,
                juzgadoInterviniente: document.getElementById('juzgadoInterviniente').value,
                numeroExpedienteJudicial: document.getElementById('numeroExpedienteJudicial').value,
                fechaInicioAccion: document.getElementById('fechaInicioAccion').value,
                estadoJudicial: document.getElementById('estadoJudicial').value,
                observacionesJudiciales: document.getElementById('observacionesJudiciales').value,
                notasGenerales: document.getElementById('notasGenerales').value,
                fechaModificacion: new Date().toISOString().split('T')[0],
            };

            try {
                // Guardar en Firestore (colecci√≥n 'casos')
                await setDoc(doc(db, 'casos', caseData.id), {
                    ...caseData,
                    fechaCreacion: currentEditingId ? (caseData.fechaCreacion || null) : (new Date().toISOString().split('T')[0]),
                    ts: serverTimestamp()
                }, { merge: true });

                // Espejo local (mantener l√≥gica existente)
                const idx = cases.findIndex(c => c.id === caseData.id);
                if (idx !== -1) cases[idx] = caseData; else cases.push(caseData);
                localStorage.setItem('defensoriaCases', JSON.stringify(cases));
                renderCases();
                closeModal();
            } catch (e) {
                alert('Error al guardar en Firestore. Revise la conexi√≥n o reglas de seguridad.');
            }
        }

        async function deleteCase(caseId) {
            if (!confirm('¬øEst√° seguro de que desea eliminar este caso? Esta acci√≥n no se puede deshacer.')) return;
            try {
                await deleteDoc(doc(db, 'casos', caseId));
                cases = cases.filter(c => c.id !== caseId);
                localStorage.setItem('defensoriaCases', JSON.stringify(cases));
                renderCases();
            } catch (e) {
                alert('No se pudo eliminar el caso en Firestore.');
            }
        }

        function viewCase(caseId) {
            const caseData = cases.find(c => c.id === caseId);
            if (!caseData) return;
            const modal = document.getElementById('detailModal');
            const modalTitle = document.getElementById('detailModalTitle');
            const modalBody = document.getElementById('detailModalBody');
            modalTitle.textContent = `Caso ${caseData.numeroExpediente}`;
            const detailsHTML = `
                <div class="detail-section">
                    <h3>Informaci√≥n General del Caso</h3>
                    <div class="detail-item"><div class="detail-label">N√∫mero de Expediente:</div><div class="detail-value">${caseData.numeroExpediente || 'No especificado'}</div></div>
                    <div class="detail-item"><div class="detail-label">Fecha de Ingreso:</div><div class="detail-value">${formatDate(caseData.fechaIngreso) || 'No especificada'}</div></div>
                    <div class="detail-item"><div class="detail-label">Estado:</div><div class="detail-value"><span class="case-status status-${caseData.estado}">${getStatusText(caseData.estado)}</span></div></div>
                    <div class="detail-item"><div class="detail-label">Prioridad:</div><div class="detail-value">${getPriorityText(caseData.prioridad)}</div></div>
                </div>
                <div class="detail-section">
                    <h3>Informaci√≥n del Menor</h3>
                    <div class="detail-item"><div class="detail-label">Nombre Completo:</div><div class="detail-value">${caseData.nombreMenor || ''} ${caseData.apellidoMenor || ''}</div></div>
                    <div class="detail-item"><div class="detail-label">DNI:</div><div class="detail-value">${caseData.dniMenor || 'No especificado'}</div></div>
                    <div class="detail-item"><div class="detail-label">Fecha de Nacimiento:</div><div class="detail-value">${formatDate(caseData.fechaNacimiento) || 'No especificada'}</div></div>
                    <div class="detail-item"><div class="detail-label">Lugar de Nacimiento:</div><div class="detail-value">${caseData.lugarNacimiento || 'No especificado'}</div></div>
                </div>
                <div class="detail-section">
                    <h3>Informaci√≥n de la Madre</h3>
                    <div class="detail-item"><div class="detail-label">Nombre Completo:</div><div class="detail-value">${caseData.nombreMadre || ''} ${caseData.apellidoMadre || ''}</div></div>
                    <div class="detail-item"><div class="detail-label">DNI:</div><div class="detail-value">${caseData.dniMadre || 'No especificado'}</div></div>
                    <div class="detail-item"><div class="detail-label">Tel√©fono:</div><div class="detail-value">${caseData.telefonoMadre || 'No especificado'}</div></div>
                    <div class="detail-item"><div class="detail-label">Domicilio:</div><div class="detail-value">${caseData.domicilioMadre || 'No especificado'}</div></div>
                </div>
                <div class="detail-section">
                    <h3>Informaci√≥n del Presunto Padre</h3>
                    <div class="detail-item"><div class="detail-label">Nombre Completo:</div><div class="detail-value">${caseData.nombrePadre || ''} ${caseData.apellidoPadre || ''}</div></div>
                    <div class="detail-item"><div class="detail-label">DNI:</div><div class="detail-value">${caseData.dniPadre || 'No especificado'}</div></div>
                    <div class="detail-item"><div class="detail-label">Tel√©fono:</div><div class="detail-value">${caseData.telefonoPadre || 'No especificado'}</div></div>
                    <div class="detail-item"><div class="detail-label">Domicilio:</div><div class="detail-value">${caseData.domicilioPadre || 'No especificado'}</div></div>
                    <div class="detail-item"><div class="detail-label">Informaci√≥n Adicional:</div><div class="detail-value">${caseData.informacionAdicionalPadre || 'No especificada'}</div></div>
                </div>
                <div class="detail-section">
                    <h3>Actuaciones Procesales</h3>
                    <div class="detail-item"><div class="detail-label">Fecha de Citaci√≥n a la Madre:</div><div class="detail-value">${formatDate(caseData.fechaCitacionMadre) || 'No realizada'}</div></div>
                    <div class="detail-item"><div class="detail-label">Fecha de Declaraci√≥n bajo Juramento:</div><div class="detail-value">${formatDate(caseData.fechaDeclaracionJuramento) || 'No realizada'}</div></div>
                    <div class="detail-item"><div class="detail-label">Fecha de Remisi√≥n al MP:</div><div class="detail-value">${formatDate(caseData.fechaRemisionMP) || 'No realizada'}</div></div>
                    <div class="detail-item"><div class="detail-label">N√∫mero de Oficio al MP:</div><div class="detail-value">${caseData.numeroOficioMP || 'No especificado'}</div></div>
                    <div class="detail-item"><div class="detail-label">Observaciones:</div><div class="detail-value">${caseData.observacionesActuaciones || 'Sin observaciones'}</div></div>
                </div>
                <div class="detail-section">
                    <h3>Seguimiento Judicial</h3>
                    <div class="detail-item"><div class="detail-label">Juzgado Interviniente:</div><div class="detail-value">${caseData.juzgadoInterviniente || 'No asignado'}</div></div>
                    <div class="detail-item"><div class="detail-label">N√∫mero de Expediente Judicial:</div><div class="detail-value">${caseData.numeroExpedienteJudicial || 'No asignado'}</div></div>
                    <div class="detail-item"><div class="detail-label">Fecha de Inicio de Acci√≥n:</div><div class="detail-value">${formatDate(caseData.fechaInicioAccion) || 'No iniciada'}</div></div>
                    <div class="detail-item"><div class="detail-label">Estado Judicial:</div><div class="detail-value">${getJudicialStatusText(caseData.estadoJudicial)}</div></div>
                    <div class="detail-item"><div class="detail-label">Observaciones Judiciales:</div><div class="detail-value">${caseData.observacionesJudiciales || 'Sin observaciones'}</div></div>
                </div>
                <div class="detail-section">
                    <h3>Notas Generales</h3>
                    <div class="detail-item"><div class="detail-label">Notas:</div><div class="detail-value">${caseData.notasGenerales || 'Sin notas adicionales'}</div></div>
                </div>`;
            modalBody.innerHTML = detailsHTML;
            modal.style.display = 'block';
        }

        function renderCases() {
            const container = document.getElementById('casesContainer');
            const noCases = document.getElementById('noCases');
            if (!cases || cases.length === 0) { container.style.display = 'none'; noCases.style.display = 'block'; return; }
            container.style.display = 'grid'; noCases.style.display = 'none';
            container.innerHTML = cases.map(caseData => `
                <div class="case-card" onclick="viewCase('${caseData.id}')">
                    <div class="case-header">
                        <div class="case-number">${caseData.numeroExpediente}</div>
                        <div class="case-status status-${caseData.estado}">${getStatusText(caseData.estado)}</div>
                    </div>
                    <div class="case-info">
                        <p><strong>Menor:</strong> ${caseData.nombreMenor} ${caseData.apellidoMenor}</p>
                        <p><strong>Madre:</strong> ${caseData.nombreMadre} ${caseData.apellidoMadre}</p>
                        <p><strong>Fecha de Ingreso:</strong> ${formatDate(caseData.fechaIngreso)}</p>
                        <p><strong>Prioridad:</strong> ${getPriorityText(caseData.prioridad)}</p>
                    </div>
                    <div class="case-actions" onclick="event.stopPropagation()">
                        <button class="btn btn-small" onclick="openModal('edit', '${caseData.id}')">‚úèÔ∏è Editar</button>
                        <button class="btn btn-danger btn-small" onclick="deleteCase('${caseData.id}')">üóëÔ∏è Eliminar</button>
                    </div>
                </div>`).join('');
        }

        window.filterCases = function() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const container = document.getElementById('casesContainer');
            if (!searchTerm) { renderCases(); return; }
            const filteredCases = cases.filter(caseData => Object.values(caseData).some(value => value && value.toString().toLowerCase().includes(searchTerm)));
            if (filteredCases.length === 0) { container.innerHTML = '<div class="no-cases"><div>üîç</div><p>No se encontraron casos que coincidan con la b√∫squeda</p></div>'; return; }
            container.innerHTML = filteredCases.map(caseData => `
                <div class="case-card" onclick="viewCase('${caseData.id}')">
                    <div class="case-header">
                        <div class="case-number">${caseData.numeroExpediente}</div>
                        <div class="case-status status-${caseData.estado}">${getStatusText(caseData.estado)}</div>
                    </div>
                    <div class="case-info">
                        <p><strong>Menor:</strong> ${caseData.nombreMenor} ${caseData.apellidoMenor}</p>
                        <p><strong>Madre:</strong> ${caseData.nombreMadre} ${caseData.apellidoMadre}</p>
                        <p><strong>Fecha de Ingreso:</strong> ${formatDate(caseData.fechaIngreso)}</p>
                        <p><strong>Prioridad:</strong> ${getPriorityText(caseData.prioridad)}</p>
                    </div>
                    <div class="case-actions" onclick="event.stopPropagation()">
                        <button class="btn btn-small" onclick="openModal('edit', '${caseData.id}')">‚úèÔ∏è Editar</button>
                        <button class="btn btn-danger btn-small" onclick="deleteCase('${caseData.id}')">üóëÔ∏è Eliminar</button>
                    </div>
                </div>`).join('');
        }

        window.printCase = function() { window.print(); }

        window.printAllCases = function() {
            const printWindow = window.open('', '_blank');
            const printContent = `<!DOCTYPE html><html><head><title>Listado Completo de Casos - Defensor√≠a Civil y Comercial 6</title>
            <style>body{font-family:Arial,sans-serif;margin:20px;} .header{text-align:center;margin-bottom:30px;} .case{border:1px solid #ddd;margin-bottom:20px;padding:15px;break-inside:avoid;} .case-header{font-weight:bold;font-size:1.2em;margin-bottom:10px;} .detail-section{margin-bottom:15px;} .detail-section h4{color:#007bff;margin-bottom:8px;} .detail-item{margin-bottom:5px;} .detail-label{font-weight:bold;display:inline-block;width:200px;}</style></head><body>
            <div class="header"><h1>Listado Completo de Casos</h1><h2>Defensor√≠a Civil y Comercial 6</h2><p>Fecha de impresi√≥n: ${new Date().toLocaleDateString('es-AR')}</p></div>
            ${cases.map(caseData => `
                <div class='case'>
                  <div class='case-header'>Caso ${caseData.numeroExpediente} - ${getStatusText(caseData.estado)}</div>
                  <div class='detail-section'><h4>Informaci√≥n General</h4>
                    <div class='detail-item'><span class='detail-label'>Fecha de Ingreso:</span> ${formatDate(caseData.fechaIngreso)}</div>
                    <div class='detail-item'><span class='detail-label'>Prioridad:</span> ${getPriorityText(caseData.prioridad)}</div>
                  </div>
                  <div class='detail-section'><h4>Menor</h4>
                    <div class='detail-item'><span class='detail-label'>Nombre:</span> ${caseData.nombreMenor} ${caseData.apellidoMenor}</div>
                    <div class='detail-item'><span class='detail-label'>DNI:</span> ${caseData.dniMenor || 'No especificado'}</div>
                    <div class='detail-item'><span class='detail-label'>Fecha de Nacimiento:</span> ${formatDate(caseData.fechaNacimiento) || 'No especificada'}</div>
                  </div>
                  <div class='detail-section'><h4>Madre</h4>
                    <div class='detail-item'><span class='detail-label'>Nombre:</span> ${caseData.nombreMadre} ${caseData.apellidoMadre}</div>
                    <div class='detail-item'><span class='detail-label'>DNI:</span> ${caseData.dniMadre || 'No especificado'}</div>
                    <div class='detail-item'><span class='detail-label'>Tel√©fono:</span> ${caseData.telefonoMadre || 'No especificado'}</div>
                  </div>
                  <div class='detail-section'><h4>Presunto Padre</h4>
                    <div class='detail-item'><span class='detail-label'>Nombre:</span> ${caseData.nombrePadre || 'No especificado'} ${caseData.apellidoPadre || ''}</div>
                    <div class='detail-item'><span class='detail-label'>DNI:</span> ${caseData.dniPadre || 'No especificado'}</div>
                    <div class='detail-item'><span class='detail-label'>Informaci√≥n Adicional:</span> ${caseData.informacionAdicionalPadre || 'No especificada'}</div>
                  </div>
                </div>`).join('')}
            </body></html>`;
            printWindow.document.write(printContent);
            printWindow.document.close();
            printWindow.print();
        }

        // Impresi√≥n desde el formulario (pedido 3)
        window.printCaseFromForm = function() {
            const val = (id) => (document.getElementById(id)?.value || '');
            const data = {
                numeroExpediente: val('numeroExpediente'), fechaIngreso: val('fechaIngreso'), estado: val('estado'), prioridad: val('prioridad'),
                nombreMenor: val('nombreMenor'), apellidoMenor: val('apellidoMenor'), fechaNacimiento: val('fechaNacimiento'), dniMenor: val('dniMenor'), lugarNacimiento: val('lugarNacimiento'),
                nombreMadre: val('nombreMadre'), apellidoMadre: val('apellidoMadre'), dniMadre: val('dniMadre'), telefonoMadre: val('telefonoMadre'), domicilioMadre: val('domicilioMadre'),
                nombrePadre: val('nombrePadre'), apellidoPadre: val('apellidoPadre'), dniPadre: val('dniPadre'), telefonoPadre: val('telefonoPadre'), domicilioPadre: val('domicilioPadre'), informacionAdicionalPadre: val('informacionAdicionalPadre'),
                fechaCitacionMadre: val('fechaCitacionMadre'), fechaDeclaracionJuramento: val('fechaDeclaracionJuramento'), fechaRemisionMP: val('fechaRemisionMP'), numeroOficioMP: val('numeroOficioMP'), observacionesActuaciones: val('observacionesActuaciones'),
                juzgadoInterviniente: val('juzgadoInterviniente'), numeroExpedienteJudicial: val('numeroExpedienteJudicial'), fechaInicioAccion: val('fechaInicioAccion'), estadoJudicial: val('estadoJudicial'), observacionesJudiciales: val('observacionesJudiciales'),
                notasGenerales: val('notasGenerales')
            };
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`<!DOCTYPE html><html><head><title>Caso ${data.numeroExpediente}</title><style>body{font-family:Arial,sans-serif;margin:20px;} .section{margin-bottom:15px;} h2{margin:0 0 10px;} .row{margin:4px 0;} .label{font-weight:bold;display:inline-block;width:220px;}</style></head><body>
                <h1>Detalle de Caso (Borrador)</h1>
                <div class='section'><h2>Informaci√≥n General</h2>
                  <div class='row'><span class='label'>N√∫mero de Expediente:</span> ${data.numeroExpediente}</div>
                  <div class='row'><span class='label'>Fecha de Ingreso:</span> ${formatDate(data.fechaIngreso)}</div>
                  <div class='row'><span class='label'>Estado:</span> ${getStatusText(data.estado)}</div>
                  <div class='row'><span class='label'>Prioridad:</span> ${getPriorityText(data.prioridad)}</div>
                </div>
                <div class='section'><h2>Menor</h2>
                  <div class='row'><span class='label'>Nombre:</span> ${data.nombreMenor} ${data.apellidoMenor}</div>
                  <div class='row'><span class='label'>DNI:</span> ${data.dniMenor}</div>
                  <div class='row'><span class='label'>Fecha de Nacimiento:</span> ${formatDate(data.fechaNacimiento)}</div>
                  <div class='row'><span class='label'>Lugar de Nacimiento:</span> ${data.lugarNacimiento}</div>
                </div>
                <div class='section'><h2>Madre</h2>
                  <div class='row'><span class='label'>Nombre:</span> ${data.nombreMadre} ${data.apellidoMadre}</div>
                  <div class='row'><span class='label'>DNI:</span> ${data.dniMadre}</div>
                  <div class='row'><span class='label'>Tel√©fono:</span> ${data.telefonoMadre}</div>
                  <div class='row'><span class='label'>Domicilio:</span> ${data.domicilioMadre}</div>
                </div>
                <div class='section'><h2>Presunto Padre</h2>
                  <div class='row'><span class='label'>Nombre:</span> ${data.nombrePadre} ${data.apellidoPadre}</div>
                  <div class='row'><span class='label'>DNI:</span> ${data.dniPadre}</div>
                  <div class='row'><span class='label'>Tel√©fono:</span> ${data.telefonoPadre}</div>
                  <div class='row'><span class='label'>Domicilio:</span> ${data.domicilioPadre}</div>
                  <div class='row'><span class='label'>Informaci√≥n Adicional:</span> ${data.informacionAdicionalPadre}</div>
                </div>
                <div class='section'><h2>Actuaciones Procesales</h2>
                  <div class='row'><span class='label'>Citaci√≥n Madre:</span> ${formatDate(data.fechaCitacionMadre)}</div>
                  <div class='row'><span class='label'>Declaraci√≥n Juramento:</span> ${formatDate(data.fechaDeclaracionJuramento)}</div>
                  <div class='row'><span class='label'>Remisi√≥n MP:</span> ${formatDate(data.fechaRemisionMP)}</div>
                  <div class='row'><span class='label'>Oficio MP:</span> ${data.numeroOficioMP}</div>
                  <div class='row'><span class='label'>Observaciones:</span> ${data.observacionesActuaciones}</div>
                </div>
                <div class='section'><h2>Seguimiento Judicial</h2>
                  <div class='row'><span class='label'>Juzgado:</span> ${data.juzgadoInterviniente}</div>
                  <div class='row'><span class='label'>Expediente Judicial:</span> ${data.numeroExpedienteJudicial}</div>
                  <div class='row'><span class='label'>Inicio de Acci√≥n:</span> ${formatDate(data.fechaInicioAccion)}</div>
                  <div class='row'><span class='label'>Estado Judicial:</span> ${getJudicialStatusText(data.estadoJudicial)}</div>
                  <div class='row'><span class='label'>Observaciones:</span> ${data.observacionesJudiciales}</div>
                </div>
                <div class='section'><h2>Notas</h2>
                  <div class='row'>${data.notasGenerales}</div>
                </div>
            </body></html>`);
            printWindow.document.close();
            printWindow.print();
        }

        // Utilidades compartidas
        window.formatDate = function(dateString) { if (!dateString) return ''; const date = new Date(dateString); return isNaN(date) ? '' : date.toLocaleDateString('es-AR'); }
        window.getStatusText = function(status) { const m={ 'pendiente':'Pendiente','en-proceso':'En Proceso','resuelto':'Resuelto' }; return m[status]||'Sin estado'; }
        window.getPriorityText = function(priority) { const m={ 'normal':'Normal','alta':'Alta','urgente':'Urgente' }; return m[priority]||'Normal'; }
        window.getJudicialStatusText = function(status) { const m={ '':'Sin acci√≥n judicial','iniciado':'Acci√≥n Iniciada','en-tramite':'En Tr√°mite','sentencia':'Con Sentencia','apelacion':'En Apelaci√≥n','firme':'Sentencia Firme' }; return m[status]||'Sin acci√≥n judicial'; }

        // Eventos
        document.getElementById('caseForm').addEventListener('submit', function(e){ e.preventDefault(); saveCaseData(); });
        window.addEventListener('click', function(event){ const caseModal=document.getElementById('caseModal'); const detailModal=document.getElementById('detailModal'); if(event.target===caseModal) closeModal(); if(event.target===detailModal) closeDetailModal(); });
    </script>
</body>
</html>
